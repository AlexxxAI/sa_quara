import os
import sys
import json
import pickle
from pathlib import Path
from datetime import datetime
from enum import Enum
from typing import Optional

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import shap
from pydantic import BaseModel, field_validator
from catboost import CatBoostClassifier, Pool

DATA_PATH = "data"
MODEL_FILENAME = "cash_loan_v3.pkl"

class NationalityEnum(str, Enum):
    saudi_arabia = "Saudi Arabia"
    indian = "India"
    spanish = "Spanish"
    egyptian = "Egyptian"
    yemeni = "Yemen"
    ethiopian = "Ethiopian"
    lebanese = "Lebanese"
    null_value = "Others"
    palestinian = "Palestinian"
    pakistani = "Pakistan"
    omani = "Omani"
    moroccan = "Moroccan"
    sri_lankan = "Sri Lankan"
    french = "French"
    bangladeshi = "Bangladeshi"
    kenyan = "Kenyan"
    sudanese = "Sudanese"
    afghani = "Afghani"
    syrian = "Syrian"
    filipino = "Filipino"
    malian = "Malian"
    turkish = "Turkish"
    jordanian = "Jordanian"
    mauritanian = "Mauritanian"
    south_african = "South African"
    italian = "Italian"
    tunisian = "Tunisian"
    british = "British"
    jamaican = "Jamaican"
    azerbaijani = "Azerbaijani"
    nepalese = "Nepalese"
    somali = "Somali"
    chadian = "Chadian"
    uzbek = "Uzbek"
    eritrean = "Eritrean"
    algerian = "Algerian"
    thai = "Thai"
    nigerian = "Nigerian"
    american = "American"
    russian = "Russian"
    iraqi = "Iraqi"
    kuwaiti = "Kuwaiti"
    ghanaian = "Ghanaian"
    indonesian = "Indonesia"
    nigerien = "Nigerien"
    bahraini = "Bahraini"

class SimahRiskEnum(str, Enum):
    Low = "Low"
    Medium = "Medium"
    Very_High = "Very High"
    Very_Low = "Very Low"
    High = "High"
    NULL = "NULL"

class GenderEnum(str, Enum):
    M = "M"
    F = "F"

class OccupationCodeEnum(str, Enum):
    _214401 = "214401"
    _931201 = "931201"
    _941202 = "941202"
    _6132115 = "6132115"
    _332201 = "332201"
    _243110 = "243110"
    _141203 = "141203"
    _9115045 = "9115045"
    _932101 = "932101"
    _723101 = "723101"
    _241101 = "241101"
    _911202 = "911202"
    _2133031 = "2133031"
    _252912 = "252912"
    _332302 = "332302"
    _132114 = "132114"
    _312301 = "312301"
    _933301 = "933301"
    _911340 = "911340"
    _6123075 = "6123075"
    _112004 = "112004"
    _441501 = "441501"
    _121104 = "121104"
    _911020 = "911020"
    _931206 = "931206"
    _9111945 = "9111945"
    _932903 = "932903"
    _832203 = "832203"
    _711501 = "711501"
    _522301 = "522301"
    _9112175 = "9112175"
    _6331025 = "6331025"
    _112002 = "112002"
    _242109 = "242109"
    _931301 = "931301"
    _512001 = "512001"
    _121314 = "121314"
    _9141014 = "9141014"
    _721303 = "721303"
    _112001 = "112001"
    _226103 = "226103"
    _962201 = "962201"
    _911350 = "911350"
    _6710 = "6710"
    _514101 = "514101"
    _325909 = "325909"
    _2212041 = "2212041"
    _334104 = "334104"
    _215101 = "215101"
    _3214072 = "3214072"
    _742202 = "742202"
    _343202 = "343202"
    _832201 = "832201"
    _753301 = "753301"
    _941101 = "941101"
    _262101 = "262101"
    _9111985 = "9111985"
    _515102 = "515102"
    _221103 = "221103"
    _421402 = "421402"
    _933402 = "933402"
    _9141034 = "9141034"
    _441901 = "441901"
    _211401 = "211401"
    _441401 = "441401"
    _933401 = "933401"
    _221213 = "221213"
    _9143013 = "9143013"
    _214201 = "214201"
    _3512042 = "3512042"
    _333905 = "333905"
    _412001 = "412001"
    _251102 = "251102"
    _311403 = "311403"
    _513202 = "513202"
    _312303 = "312303"
    _721201 = "721201"
    _754902 = "754902"
    _241306 = "241306"
    _251101 = "251101"
    _722101 = "722101"
    _513101 = "513101"
    _723104 = "723104"
    _1212031 = "1212031"
    _9141045 = "9141045"
    _112008 = "112008"
    _9214124 = "9214124"
    _911330 = "911330"
    _741201 = "741201"
    _351301 = "351301"
    _132418 = "132418"
    _6132045 = "6132045"
    _821903 = "821903"
    _226108 = "226108"
    _3214042 = "3214042"
    _122103 = "122103"
    _522201 = "522201"
    _225001 = "225001"
    _313907 = "313907"
    _343101 = "343101"
    _2133201 = "2133201"
    _261101 = "261101"
    _721304 = "721304"
    _932902 = "932902"
    _3216042 = "3216042"
    _121207 = "121207"
    _932901 = "932901"
    _264301 = "264301"
    _9222035 = "9222035"
    _351304 = "351304"
    _3311012 = "3311012"
    _216102 = "216102"
    _741101 = "741101"
    _751401 = "751401"
    _252201 = "252201"
    _351202 = "351202"
    _311805 = "311805"
    _226202 = "226202"
    _413101 = "413101"
    _214912 = "214912"
    _122104 = "122104"
    _3213212 = "3213212"
    _332102 = "332102"
    _532202 = "532202"
    _215204 = "215204"
    _122101 = "122101"
    _335907 = "335907"
    _2311901 = "2311901"
    _2218181 = "2218181"
    _311204 = "311204"
    _243109 = "243109"
    _2322011 = "2322011"
    _2513041 = "2513041"
    _832205 = "832205"
    _311105 = "311105"
    _242401 = "242401"
    _325701 = "325701"
    _912201 = "912201"
    _243102 = "243102"
    _753401 = "753401"
    _751203 = "751203"
    _221201 = "221201"
    _232001 = "232001"
    _226201 = "226201"
    _713203 = "713203"
    _265407 = "265407"
    _243303 = "243303"
    _141205 = "141205"
    _222101 = "222101"
    _216101 = "216101"
    _3212112 = "3212112"
    _2421991 = "2421991"
    _241303 = "241303"
    _3422012 = "3422012"
    _5111043 = "5111043"
    _7111095 = "7111095"
    _311502 = "311502"
    _112007 = "112007"
    _312202 = "312202"
    _3215362 = "3215362"
    _132102 = "132102"
    _242106 = "242106"
    _221101 = "221101"
    _814301 = "814301"
    _524601 = "524601"
    _833101 = "833101"
    _911070 = "911070"
    _233001 = "233001"
    _2311011 = "2311011"
    _911203 = "911203"
    _721302 = "721302"
    _264303 = "264303"
    _352107 = "352107"
    _214914 = "214914"
    _141101 = "141101"
    _432102 = "432102"
    _711101 = "711101"
    _9214154 = "9214154"
    _311511 = "311511"
    _833201 = "833201"
    _3621022 = "3621022"
    _711401 = "711401"
    _3631032 = "3631032"
    _833203 = "833203"
    _2311941 = "2311941"
    _834207 = "834207"
    _753102 = "753102"
    _818204 = "818204"
    _2214011 = "2214011"
    _2432991 = "2432991"
    _524201 = "524201"
    _4234013 = "4234013"
    _2320 = "2320"
    _311514 = "311514"
    _215201 = "215201"
    _251201 = "251201"
    _311801 = "311801"
    _6122055 = "6122055"
    _142003 = "142003"
    _226101 = "226101"
    _6121015 = "6121015"
    _9412085 = "9412085"
    _226302 = "226302"
    _515101 = "515101"
    _234103 = "234103"
    _522311 = "522311"
    _235602 = "235602"
    _226501 = "226501"
    _321402 = "321402"
    _132417 = "132417"
    _242205 = "242205"
    _522319 = "522319"
    _321102 = "321102"
    _343401 = "343401"
    _214101 = "214101"
    _211301 = "211301"
    _3313032 = "3313032"
    _1217131 = "1217131"
    _7110 = "7110"
    _432103 = "432103"
    _511203 = "511203"
    _311404 = "311404"
    _5112013 = "5112013"
    _311409 = "311409"
    _242120 = "242120"
    _421103 = "421103"
    _234202 = "234202"
    _216604 = "216604"
    _216301 = "216301"
    _251401 = "251401"
    _2315071 = "2315071"
    _322101 = "322101"
    _111123 = "111123"
    _3422062 = "3422062"
    _241102 = "241102"
    _214501 = "214501"
    _243105 = "243105"
    _431101 = "431101"
    _215301 = "215301"
    _413201 = "413201"
    _212004 = "212004"
    _6132093 = "6132093"
    _351101 = "351101"
    _226701 = "226701"
    _62420 = "62420"
    _226405 = "226405"
    _2311031 = "2311031"
    _522310 = "522310"
    _3423032 = "3423032"
    _351302 = "351302"
    _2212011 = "2212011"
    _214202 = "214202"
    _431201 = "431201"
    _311305 = "311305"
    _242108 = "242108"
    _235903 = "235903"
    _3215062 = "3215062"
    _312203 = "312203"
    _311211 = "311211"
    _313402 = "313402"
    _3632012 = "3632012"
    _214404 = "214404"
    _234101 = "234101"
    _422103 = "422103"
    _2133311 = "2133311"
    _222201 = "222201"
    _3316042 = "3316042"
    _325601 = "325601"
    _2133111 = "2133111"
    _214905 = "214905"
    _3217032 = "3217032"
    _331302 = "331302"
    _311408 = "311408"
    _411002 = "411002"
    _7121135 = "7121135"
    _251205 = "251205"
    _235906 = "235906"
    _216603 = "216603"
    _315306 = "315306"
    _2211991 = "2211991"
    _3219052 = "3219052"
    _522304 = "522304"
    _216601 = "216601"
    _5211095 = "5211095"
    _413102 = "413102"
    _214412 = "214412"
    _313201 = "313201"
    _313901 = "313901"
    _333202 = "333202"
    _3123062 = "3123062"
    _214909 = "214909"
    _252202 = "252202"
    _911030 = "911030"
    _2215011 = "2215011"
    _321201 = "321201"
    _215208 = "215208"
    _216303 = "216303"
    _331301 = "331301"
    _242203 = "242203"
    _3214092 = "3214092"
    _342301 = "342301"
    _235203 = "235203"
    _512002 = "512002"
    _234109 = "234109"
    _233030 = "233030"
    _311302 = "311302"
    _342201 = "342201"
    _213108 = "213108"
    _242201 = "242201"
    _215104 = "215104"
    _121904 = "121904"
    _351102 = "351102"
    _2133021 = "2133021"
    _522318 = "522318"
    _241304 = "241304"
    _2111981 = "2111981"
    _333901 = "333901"
    _325403 = "325403"
    _233025 = "233025"
    _234102 = "234102"
    _312201 = "312201"
    _233027 = "233027"
    _2111111 = "2111111"
    _334401 = "334401"
    _215206 = "215206"
    _213201 = "213201"
    _532103 = "532103"
    _242103 = "242103"
    _121305 = "121305"
    _332202 = "332202"
    _522320 = "522320"
    _243402 = "243402"
    _243107 = "243107"
    _311507 = "311507"
    _3611032 = "3611032"
    _441203 = "441203"
    _215108 = "215108"
    _422601 = "422601"
    _911360 = "911360"
    _224002 = "224002"
    _4122043 = "4122043"
    _3215252 = "3215252"
    _1999999 = "1999999"
    _233003 = "233003"
    _212003 = "212003"
    _331404 = "331404"
    _351201 = "351201"
    _532101 = "532101"
    _514203 = "514203"
    _252105 = "252105"
    _213114 = "213114"
    _214206 = "214206"
    _214904 = "214904"
    _332403 = "332403"
    _2421491 = "2421491"
    _132303 = "132303"
    _241103 = "241103"
    _251108 = "251108"
    _422102 = "422102"
    _431202 = "431202"
    _99300 = "99300"
    _754301 = "754301"
    _263608 = "263608"
    _311213 = "311213"
    _343510 = "343510"
    _333203 = "333203"
    _741207 = "741207"
    _514202 = "514202"
    _252104 = "252104"
    _221230 = "221230"
    _243203 = "243203"
    _314303 = "314303"
    _111211 = "111211"
    _261106 = "261106"
    _121902 = "121902"
    _216505 = "216505"
    _214105 = "214105"
    _351203 = "351203"
    _325401 = "325401"
    _334102 = "334102"
    _5112993 = "5112993"
    _931202 = "931202"
    _242105 = "242105"
    _263401 = "263401"
    _523001 = "523001"
    _334301 = "334301"
    _233034 = "233034"
    _333302 = "333302"
    _3215982 = "3215982"
    _233011 = "233011"
    _311301 = "311301"
    _234108 = "234108"
    _352202 = "352202"
    _741202 = "741202"
    _251202 = "251202"
    _754302 = "754302"
    _311209 = "311209"
    _311508 = "311508"
    _311304 = "311304"
    _241110 = "241110"
    _814102 = "814102"
    _221218 = "221218"
    _514102 = "514102"
    _522302 = "522302"
    _315401 = "315401"
    _265102 = "265102"
    _325703 = "325703"
    _912301 = "912301"
    _311405 = "311405"
    _216302 = "216302"
    _752202 = "752202"
    _121311 = "121311"
    _352105 = "352105"
    _231026 = "231026"
    _222114 = "222114"
    _6132035 = "6132035"
    _121101 = "121101"
    _234105 = "234105"
    _4123083 = "4123083"
    _241309 = "241309"
    _0 = "0"
    _311509 = "311509"
    _311904 = "311904"
    _711502 = "711502"
    _311906 = "311906"
    _732201 = "732201"
    _241302 = "241302"
    _141204 = "141204"
    _226401 = "226401"

class InputData(BaseModel):
    requested_amount: float
    nationality: NationalityEnum
    simah_risk: SimahRiskEnum
    simah_score: float
    dbr_ofo_amt: float
    dbr_omo_amt: float
    actualdbrdebt: float
    total_allowance: float
    dbr_maleem_bmo_dbr: float
    dbr_maleem_omo_dbr: float
    dbr_omo_dbr: float
    svr_jdg_count: float
    svr_defaultamount: float
    Gender: GenderEnum
    occupationcode: str

    @field_validator("occupationcode", mode="before")
    def occupationcode_to_str(cls, v):
        if v is None:
            return ""  # or whatever default you prefer
        return str(v).strip()


class ScoreModel:
    def __init__(self, model_path: str = None):
        if model_path is None:
            model_path = os.path.join(DATA_PATH, MODEL_FILENAME)
        with open(model_path, "rb") as f:
            self.model: CatBoostClassifier = pickle.load(f)

        self.numeric_cols = [
            "requested_amount", "simah_score", "dbr_ofo_amt", "dbr_omo_amt",
            "actualdbrdebt", "total_allowance", "dbr_maleem_bmo_dbr",
            "dbr_maleem_omo_dbr", "dbr_omo_dbr", "svr_jdg_count",
            "svr_defaultamount"
        ]
        self.cat_features = ["nationality", "simah_risk", "Gender", "occupationcode"]

    def preprocess_data(self, input_data: InputData):
        data = input_data.dict()
        return pd.DataFrame([data])

    def predict(self, input_data: InputData, threshold: float = 0.5):
        data_df = self.preprocess_data(input_data)
        pool = Pool(data_df, cat_features=self.cat_features)
        proba = float(self.model.predict_proba(pool)[0, 1])
        decision = "Approve" if proba < threshold else "Reject"
        shap_values_all = self.model.get_feature_importance(pool, type="ShapValues")[0]
        shap_values = shap_values_all[:-1]
        shap_output = [{"feature": f, "value": float(v)} for f, v in zip(data_df.columns, shap_values)]
        return data_df, {
            "probability_of_default": proba,
            "decision": decision,
            "shap_values": shap_output
        }